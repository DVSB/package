"use strict";var Markdowns=function(){require("../library/_Boilerplate").call(this),this.getAllMarkdownsObjects()};require("util").inherits(Markdowns,require("../library/_Boilerplate")),Markdowns.prototype.getAllMarkdownsObjects=function(){var a=this,b=".";this.walkFiles(b,function(b){a.markdowns=b,a.removeTemplatesAndBuildFolder()})},Markdowns.prototype.removeTemplatesAndBuildFolder=function(){function a(a){return a.indexOf(".DS_Store")<=-1}function b(a){return a.indexOf(f)<=-1}function c(a){return a.indexOf(e)<=-1}function d(a){var b=a.substr(a.lastIndexOf("."));return".md"===b}var e="./"+global.downpress.config["dir-templates"],f="./"+global.downpress.config["dir-build"];this.markdowns=this.markdowns.filter(a),this.markdowns=this.markdowns.filter(c),this.markdowns=this.markdowns.filter(b),this.markdowns=this.markdowns.filter(d),this.readMarkdownsOneByOne()},Markdowns.prototype.readMarkdownsOneByOne=function(){function a(){g++,e.markdowns.length===g&&d()}function b(a){e.fs.readFile(a,function(a,b){c(a,b,g)})}function c(b,c,d){if(b)throw b;var g={data:c+"",path:e.markdowns[d]};f.push(g),a()}function d(){e.markdowns=f,e.parseAllMarkdowns()}var e=this,f=[],g=0;this.markdowns.forEach(b)},Markdowns.prototype.parseAllMarkdowns=function(){function a(a){var d=b.getHeaderMetaTags(a.data);d._content=b.getContentBody(a),d._path=a.path,d.template&&c.push(d)}var b=this,c=[];this.markdowns.forEach(a),this.markdowns=c,this.addAllMetaTags()},Markdowns.prototype.addAllMetaTags=function(){var a=this;this.markdowns.forEach(function(b,c){var d=b._path,e=d.substr(0,d.lastIndexOf("/")+1);a.markdowns[c]._path=e.substr(1),a.markdowns[c]._origin=d.substr(d.lastIndexOf("/")+1),a.markdowns[c]._target=d.substr(d.lastIndexOf("/")+1),a.markdowns[c]._target=a.markdowns[c]._target.replace(".md",".html"),a.markdowns[c]._uniqid=a.getRandomID(),a.markdowns[c]._content=require("marked")(b._content)}),global.downpress.markdowns=this.markdowns,this.emit("ready")},Markdowns.prototype.getHeaderMetaTags=function(a){var b=this,c={},d=a.split(/\n/),e=global.downpress.config["markdown-delimiter"],f=d.indexOf(e,0),g=d.indexOf(e,1),h=d.slice(f+1,g);return h.forEach(function(a){var d=b.clearKeysAndValues(a);c[d.title]=d.value}),c},Markdowns.prototype.clearKeysAndValues=function(a){var b=a.substr(0,a.indexOf(":")),c=a.substr(a.indexOf(":")+1);return b=this.underscore.clean(b),c=this.underscore.clean(c),{title:b,value:c}},Markdowns.prototype.getContentBody=function(a){var b=a.data,c=b.split(/\n/),d=global.downpress.config["markdown-delimiter"],e=c.indexOf(d,1),f=c.slice(e+1);return f.join("\n")},Markdowns.prototype.getRandomID=function(){var a=Math.floor(8e5*Math.random()+1e5),b=Math.floor(8e5*Math.random()+1e5),c=Math.floor(8e5*Math.random()+1e5);return(a+b+c).toString(36)},module.exports=function(){return new Markdowns};